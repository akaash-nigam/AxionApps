name: PR Automation

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [ main, develop ]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  auto-label:
    name: Auto Label PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Label based on files changed
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml

      - name: Label by size
        uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: 'size/XS'
          xs_max_size: 10
          s_label: 'size/S'
          s_max_size: 100
          m_label: 'size/M'
          m_max_size: 500
          l_label: 'size/L'
          l_max_size: 1000
          xl_label: 'size/XL'

  code-review:
    name: Automated Code Review
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run SwiftLint for PR
        uses: norio-nomura/action-swiftlint@3.2.1
        with:
          args: --strict
        continue-on-error: true

      - name: Complexity analysis
        uses: mathiasvr/command-output@v2.0.0
        id: complexity
        with:
          run: |
            # Install lizard for complexity analysis
            pip install lizard
            lizard BusinessOperatingSystem -l swift --CCN 15
        continue-on-error: true

      - name: Comment complexity results
        uses: actions/github-script@v7
        with:
          script: |
            const output = `${{ steps.complexity.outputs.stdout }}`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ðŸ“Š Complexity Analysis\n\n```\n' + output + '\n```'
            });

  security-review:
    name: Security Review
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run CodeQL
        uses: github/codeql-action/analyze@v3
        with:
          languages: swift
        continue-on-error: true

      - name: Check for hardcoded secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          deny-licenses: GPL-3.0, AGPL-3.0

  test-coverage:
    name: Test Coverage Report
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Select Xcode version
        run: |
          sudo xcode-select -s /Applications/Xcode_16.0.app/Contents/Developer

      - name: Run tests with coverage
        run: |
          xcodebuild test \
            -scheme BusinessOperatingSystem \
            -destination 'platform=visionOS Simulator,name=Apple Vision Pro' \
            -configuration Debug \
            -enableCodeCoverage YES \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            | xcpretty
        continue-on-error: true

      - name: Generate coverage report
        run: |
          xcrun llvm-cov export \
            -format="lcov" \
            -instr-profile=$(find ~/Library/Developer/Xcode/DerivedData -name "*.profdata") \
            $(find ~/Library/Developer/Xcode/DerivedData -name "*.xctest") \
            > coverage.lcov
        continue-on-error: true

      - name: Comment PR with coverage
        uses: romeovs/lcov-reporter-action@v0.3.1
        with:
          lcov-file: ./coverage.lcov
          github-token: ${{ secrets.GITHUB_TOKEN }}
          delete-old-comments: true
        continue-on-error: true

  api-diff:
    name: API Diff Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check API spec changes
        id: api_changes
        run: |
          if git diff --name-only origin/${{ github.base_ref }} HEAD | grep -q "api-specification.yaml"; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate API diff
        if: steps.api_changes.outputs.changed == 'true'
        uses: oasdiff/oasdiff-action/breaking@v0.0.15
        with:
          base: origin/${{ github.base_ref }}:api-specification.yaml
          revision: HEAD:api-specification.yaml
          format: markdown
        continue-on-error: true

      - name: Comment API changes
        if: steps.api_changes.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ðŸ”„ API Specification Changed\n\nâš ï¸ This PR modifies the API specification. Please ensure:\n- [ ] Breaking changes are documented\n- [ ] API version is updated if needed\n- [ ] Backend team is notified\n- [ ] Migration guide is created for breaking changes'
            });

  pr-checklist:
    name: PR Checklist Validator
    runs-on: ubuntu-latest
    steps:
      - name: Check PR description
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';

            const requiredSections = [
              '## Description',
              '## Changes',
              '## Testing'
            ];

            const missingSections = requiredSections.filter(section => !body.includes(section));

            if (missingSections.length > 0) {
              const comment = `## âš ï¸ PR Description Incomplete\n\nYour PR is missing the following sections:\n${missingSections.map(s => `- ${s}`).join('\n')}\n\nPlease update your PR description to include these sections.`;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });

              core.setFailed('PR description is incomplete');
            }

  performance-check:
    name: Performance Baseline
    runs-on: macos-14
    if: contains(github.event.pull_request.labels.*.name, 'performance')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: |
          sudo xcode-select -s /Applications/Xcode_16.0.app/Contents/Developer

      - name: Run performance tests
        run: |
          xcodebuild test \
            -scheme BusinessOperatingSystem \
            -destination 'platform=visionOS Simulator,name=Apple Vision Pro' \
            -only-testing:BusinessOperatingSystemTests/PerformanceTests \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO
        continue-on-error: true

      - name: Comment performance results
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ðŸš€ Performance Tests\n\nPerformance tests have been run. Check the workflow logs for detailed results.'
            });

  auto-merge:
    name: Auto-merge Dependabot PRs
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    needs: [code-review, security-review, dependency-review, test-coverage]
    steps:
      - name: Auto-approve
        uses: hmarr/auto-approve-action@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable auto-merge
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [auto-label, code-review, security-review, test-coverage]
    if: always()
    steps:
      - name: Create PR summary comment
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = {
              'Auto Label': '${{ needs.auto-label.result }}',
              'Code Review': '${{ needs.code-review.result }}',
              'Security Review': '${{ needs.security-review.result }}',
              'Test Coverage': '${{ needs.test-coverage.result }}'
            };

            const getEmoji = (status) => {
              switch(status) {
                case 'success': return 'âœ…';
                case 'failure': return 'âŒ';
                case 'skipped': return 'â­ï¸';
                default: return 'â³';
              }
            };

            const summary = Object.entries(jobs)
              .map(([name, status]) => `${getEmoji(status)} ${name}: ${status}`)
              .join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ“‹ PR Automation Summary\n\n${summary}\n\n---\n*Automated checks completed at ${new Date().toISOString()}*`
            });

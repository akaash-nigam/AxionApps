name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint:
    name: SwiftLint
    runs-on: macos-14

    steps:
    - uses: actions/checkout@v4

    - name: Install SwiftLint
      run: brew install swiftlint

    - name: Run SwiftLint
      run: swiftlint lint --strict

  test:
    name: Unit Tests
    runs-on: macos-14

    steps:
    - uses: actions/checkout@v4

    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode_16.0.app

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Run Unit Tests
      run: |
        xcodebuild test \
          -scheme SpatialScreenplayWorkshop \
          -destination 'platform=visionOS Simulator,name=Apple Vision Pro' \
          -enableCodeCoverage YES \
          | xcpretty

    - name: Upload Coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  build:
    name: Build
    runs-on: macos-14

    strategy:
      matrix:
        configuration: [Debug, Release]

    steps:
    - uses: actions/checkout@v4

    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode_16.0.app

    - name: Build (${{ matrix.configuration }})
      run: |
        xcodebuild build \
          -scheme SpatialScreenplayWorkshop \
          -configuration ${{ matrix.configuration }} \
          -destination 'platform=visionOS Simulator,name=Apple Vision Pro' \
          | xcpretty

  integration-test:
    name: Integration Tests
    runs-on: macos-14
    needs: [lint, build]

    steps:
    - uses: actions/checkout@v4

    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode_16.0.app

    - name: Run Integration Tests
      run: |
        xcodebuild test \
          -scheme SpatialScreenplayWorkshop \
          -destination 'platform=visionOS Simulator,name=Apple Vision Pro' \
          -testPlan IntegrationTests \
          | xcpretty

  performance-test:
    name: Performance Tests
    runs-on: macos-14
    needs: [lint, build]

    steps:
    - uses: actions/checkout@v4

    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode_16.0.app

    - name: Run Performance Tests
      run: |
        xcodebuild test \
          -scheme SpatialScreenplayWorkshop \
          -destination 'platform=visionOS Simulator,name=Apple Vision Pro' \
          -testPlan PerformanceTests \
          | xcpretty

    - name: Upload Performance Results
      uses: actions/upload-artifact@v3
      with:
        name: performance-results
        path: performance-results.json

  analyze:
    name: Static Analysis
    runs-on: macos-14

    steps:
    - uses: actions/checkout@v4

    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode_16.0.app

    - name: Run Static Analyzer
      run: |
        xcodebuild analyze \
          -scheme SpatialScreenplayWorkshop \
          -destination 'platform=visionOS Simulator,name=Apple Vision Pro' \
          | xcpretty

  docs:
    name: Documentation
    runs-on: macos-14

    steps:
    - uses: actions/checkout@v4

    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode_16.0.app

    - name: Build Documentation
      run: |
        xcodebuild docbuild \
          -scheme SpatialScreenplayWorkshop \
          -destination 'platform=visionOS Simulator,name=Apple Vision Pro'

    - name: Upload Documentation
      uses: actions/upload-artifact@v3
      with:
        name: documentation
        path: .build/documentation

  notify:
    name: Notification
    runs-on: ubuntu-latest
    needs: [lint, test, build, integration-test]
    if: always()

    steps:
    - name: Check Status
      run: |
        if [ "${{ needs.test.result }}" == "failure" ]; then
          echo "Tests failed!"
          exit 1
        fi

    - name: Send Slack Notification
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: 'CI Pipeline Failed'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}

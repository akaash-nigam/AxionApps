name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-and-release:
    name: Build and Create Release
    runs-on: macos-14

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode_16.0.app

    - name: Get Version
      id: version
      run: |
        echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Update Version in Project
      run: |
        agvtool new-marketing-version ${{ steps.version.outputs.VERSION }}
        agvtool next-version -all

    - name: Install Dependencies
      run: |
        brew install swiftlint
        gem install fastlane

    - name: Run Tests
      run: |
        xcodebuild test \
          -scheme SpatialScreenplayWorkshop \
          -destination 'platform=visionOS Simulator,name=Apple Vision Pro' \
          | xcpretty

    - name: Build Release
      run: |
        xcodebuild archive \
          -scheme SpatialScreenplayWorkshop \
          -configuration Release \
          -archivePath ./build/SpatialScreenplayWorkshop.xcarchive \
          | xcpretty

    - name: Export IPA
      run: |
        xcodebuild -exportArchive \
          -archivePath ./build/SpatialScreenplayWorkshop.xcarchive \
          -exportPath ./build \
          -exportOptionsPlist ExportOptions.plist

    - name: Generate Changelog
      id: changelog
      run: |
        git log $(git describe --tags --abbrev=0 HEAD^)..HEAD --pretty=format:"* %s (%h)" > CHANGELOG.txt
        echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
        cat CHANGELOG.txt >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version.outputs.TAG }}
        release_name: Release ${{ steps.version.outputs.VERSION }}
        body: |
          ## What's Changed

          ${{ steps.changelog.outputs.CHANGELOG }}

          ## Installation

          Download the IPA and install via TestFlight or Xcode.

          ## Requirements

          - Apple Vision Pro
          - visionOS 2.0+
        draft: false
        prerelease: false

    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./build/SpatialScreenplayWorkshop.ipa
        asset_name: SpatialScreenplayWorkshop-${{ steps.version.outputs.VERSION }}.ipa
        asset_content_type: application/octet-stream

    - name: Upload to TestFlight
      env:
        FASTLANE_USER: ${{ secrets.FASTLANE_USER }}
        FASTLANE_PASSWORD: ${{ secrets.FASTLANE_PASSWORD }}
        FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.FASTLANE_APP_PASSWORD }}
      run: |
        fastlane pilot upload \
          --ipa ./build/SpatialScreenplayWorkshop.ipa \
          --skip_waiting_for_build_processing

    - name: Send Release Notification
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: 'New Release: v${{ steps.version.outputs.VERSION }}'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}

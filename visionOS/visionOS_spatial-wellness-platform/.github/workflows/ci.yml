name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop, 'claude/**' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  SWIFT_VERSION: '6.0'
  XCODE_VERSION: '16.0'

jobs:
  # Swift Unit Tests
  swift-tests:
    name: Swift Unit & Integration Tests
    runs-on: macos-14
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer

      - name: Cache Swift Package Manager
        uses: actions/cache@v3
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Install dependencies
        run: |
          cd SpatialWellness
          swift package resolve

      - name: Build for testing
        run: |
          cd SpatialWellness
          swift build --build-tests

      - name: Run Unit Tests
        run: |
          cd SpatialWellness
          swift test --filter ModelTests --enable-code-coverage

      - name: Run ViewModel Tests
        run: |
          cd SpatialWellness
          swift test --filter ViewModelTests --enable-code-coverage

      - name: Run Service Tests
        run: |
          cd SpatialWellness
          swift test --filter ServiceTests --enable-code-coverage
        continue-on-error: true

      - name: Generate code coverage report
        run: |
          cd SpatialWellness
          xcrun llvm-cov export -format="lcov" \
            .build/debug/SpatialWellnessPackageTests.xctest/Contents/MacOS/SpatialWellnessPackageTests \
            -instr-profile .build/debug/codecov/default.profdata > coverage.lcov
        continue-on-error: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./SpatialWellness/coverage.lcov
          flags: swift-tests
          name: swift-coverage
        continue-on-error: true

      - name: Archive test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: swift-test-results
          path: |
            SpatialWellness/.build/debug/
            SpatialWellness/coverage.lcov

  # visionOS UI Tests
  visionos-ui-tests:
    name: visionOS UI Tests
    runs-on: macos-14
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer

      - name: List available simulators
        run: xcrun simctl list devices available

      - name: Boot visionOS Simulator
        run: |
          SIMULATOR_ID=$(xcrun simctl list devices available | grep "Apple Vision Pro" | head -1 | grep -oE '[A-F0-9-]{36}')
          echo "Booting simulator: $SIMULATOR_ID"
          xcrun simctl boot "$SIMULATOR_ID"

      - name: Build for visionOS
        run: |
          cd SpatialWellness
          xcodebuild build-for-testing \
            -scheme SpatialWellness \
            -destination 'platform=visionOS Simulator,name=Apple Vision Pro' \
            -derivedDataPath .build

      - name: Run UI Tests
        run: |
          cd SpatialWellness
          xcodebuild test-without-building \
            -scheme SpatialWellness \
            -destination 'platform=visionOS Simulator,name=Apple Vision Pro' \
            -derivedDataPath .build \
            -resultBundlePath TestResults.xcresult
        continue-on-error: true

      - name: Archive UI test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: visionos-ui-test-results
          path: SpatialWellness/TestResults.xcresult

  # Performance Tests
  performance-tests:
    name: Performance Benchmarks
    runs-on: macos-14
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer

      - name: Run Performance Tests
        run: |
          cd SpatialWellness
          swift test --filter PerformanceTests

      - name: Check performance metrics
        run: |
          echo "Checking performance baselines..."
          # Future: Compare against baseline metrics

  # Landing Page Tests
  landing-page-tests:
    name: Landing Page Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install validation tools
        run: |
          npm install -g html-validate
          npm install -g stylelint stylelint-config-standard
          npm install -g eslint

      - name: Validate HTML
        run: |
          cd landing-page
          npx html-validate index.html
        continue-on-error: true

      - name: Validate CSS
        run: |
          cd landing-page
          echo '{"extends": "stylelint-config-standard"}' > .stylelintrc.json
          npx stylelint "css/**/*.css"
        continue-on-error: true

      - name: Validate JavaScript
        run: |
          cd landing-page
          echo '{"env": {"browser": true, "es2021": true}, "extends": "eslint:recommended", "parserOptions": {"ecmaVersion": 2021}}' > .eslintrc.json
          npx eslint "js/**/*.js"
        continue-on-error: true

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            file://${{ github.workspace }}/landing-page/index.html
          uploadArtifacts: true
          temporaryPublicStorage: true
        continue-on-error: true

  # Code Quality & Security
  code-quality:
    name: Code Quality & Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run SwiftLint
        uses: norio-nomura/action-swiftlint@3.2.1
        with:
          args: --strict
        continue-on-error: true

      - name: Security scan with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

  # Accessibility Tests
  accessibility-tests:
    name: Accessibility Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install accessibility tools
        run: npm install -g @axe-core/cli pa11y-ci

      - name: Run axe accessibility tests
        run: |
          cd landing-page
          npx axe index.html --exit
        continue-on-error: true

      - name: Run pa11y accessibility tests
        run: |
          cd landing-page
          echo '{"urls": ["index.html"]}' > .pa11yci.json
          npx pa11y-ci
        continue-on-error: true

  # Integration Test Results
  test-summary:
    name: Test Summary & Report
    runs-on: ubuntu-latest
    needs: [swift-tests, visionos-ui-tests, performance-tests, landing-page-tests, code-quality, accessibility-tests]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Generate test summary
        run: |
          echo "# Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- Swift Unit Tests: ${{ needs.swift-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- visionOS UI Tests: ${{ needs.visionos-ui-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Performance Tests: ${{ needs.performance-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Landing Page Tests: ${{ needs.landing-page-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Code Quality: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Accessibility: ${{ needs.accessibility-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Coverage" >> $GITHUB_STEP_SUMMARY
          echo "Code coverage reports are available in the artifacts." >> $GITHUB_STEP_SUMMARY

  # Deployment staging (only on main branch)
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [test-summary]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy landing page to staging
        run: |
          echo "Deploying landing page to staging environment..."
          # Future: Add actual deployment steps (S3, Vercel, Netlify, etc.)

      - name: Notify deployment
        run: |
          echo "Staging deployment complete"
          # Future: Add Slack/email notifications

name: CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  XCODE_VERSION: '16.0'

jobs:
  build:
    name: Build and Test
    runs-on: macos-14

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Cache Swift packages
      uses: actions/cache@v3
      with:
        path: .build
        key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-

    - name: Build
      run: |
        swift build -v

    - name: Run tests
      run: |
        swift test --enable-code-coverage

    - name: Generate code coverage
      run: |
        xcrun llvm-cov export \
          .build/debug/TacticalTeamShootersPackageTests.xctest/Contents/MacOS/TacticalTeamShootersPackageTests \
          -instr-profile .build/debug/codecov/default.profdata \
          -format="lcov" > coverage.lcov

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.lcov
        fail_ci_if_error: false

  lint:
    name: SwiftLint
    runs-on: macos-14

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install SwiftLint
      run: brew install swiftlint

    - name: Run SwiftLint
      run: swiftlint lint --strict

  security:
    name: Security Scan
    runs-on: macos-14

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run security scan
      run: |
        # Check for common security issues
        grep -r "TODO.*security" . || true
        grep -r "FIXME.*security" . || true

    - name: Check for secrets
      run: |
        # Check for accidentally committed secrets
        ! grep -r "api_key\s*=" . || exit 1
        ! grep -r "password\s*=" . || exit 1

  archive:
    name: Archive Build
    runs-on: macos-14
    if: github.ref == 'refs/heads/main'
    needs: [build, lint]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

    - name: Archive
      run: |
        xcodebuild archive \
          -scheme TacticalTeamShooters \
          -destination 'generic/platform=visionOS' \
          -archivePath ./build/TacticalTeamShooters.xcarchive \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

    - name: Upload archive
      uses: actions/upload-artifact@v3
      with:
        name: TacticalTeamShooters-Archive
        path: ./build/TacticalTeamShooters.xcarchive

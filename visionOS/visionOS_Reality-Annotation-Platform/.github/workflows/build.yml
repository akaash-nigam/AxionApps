name: Build

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  SCHEME: RealityAnnotation
  CONFIGURATION: Release

jobs:
  build-simulator:
    name: Build for Simulator
    runs-on: macos-14
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for Xcode project
        id: check-project
        run: |
          if [ -f "RealityAnnotation.xcodeproj/project.pbxproj" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Xcode
        if: steps.check-project.outputs.exists == 'true'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Show Xcode and SDK versions
        if: steps.check-project.outputs.exists == 'true'
        run: |
          xcodebuild -version
          xcodebuild -showsdks

      - name: Build for simulator
        if: steps.check-project.outputs.exists == 'true'
        run: |
          xcodebuild build \
            -scheme "${{ env.SCHEME }}" \
            -configuration "${{ env.CONFIGURATION }}" \
            -destination "generic/platform=visionOS Simulator" \
            -derivedDataPath DerivedData \
            | xcpretty

      - name: Check build size
        if: steps.check-project.outputs.exists == 'true'
        run: |
          APP_PATH=$(find DerivedData -name "*.app" | head -n 1)
          if [ -n "$APP_PATH" ]; then
            SIZE=$(du -sh "$APP_PATH" | cut -f1)
            echo "ðŸ“¦ App size: $SIZE" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Skip message
        if: steps.check-project.outputs.exists == 'false'
        run: |
          echo "âš ï¸ Xcode project not found. Skipping build."
          echo "Follow Xcode_Setup_Guide.md to create the project first."

  build-device:
    name: Build for Device
    runs-on: macos-14
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for Xcode project
        id: check-project
        run: |
          if [ -f "RealityAnnotation.xcodeproj/project.pbxproj" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Xcode
        if: steps.check-project.outputs.exists == 'true'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build for device
        if: steps.check-project.outputs.exists == 'true'
        run: |
          xcodebuild build \
            -scheme "${{ env.SCHEME }}" \
            -configuration "${{ env.CONFIGURATION }}" \
            -destination "generic/platform=visionOS" \
            -derivedDataPath DerivedData \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty

  archive:
    name: Archive Build
    runs-on: macos-14
    timeout-minutes: 45
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for Xcode project
        id: check-project
        run: |
          if [ -f "RealityAnnotation.xcodeproj/project.pbxproj" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Xcode
        if: steps.check-project.outputs.exists == 'true'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Import code signing certificate
        if: steps.check-project.outputs.exists == 'true' && env.CERTIFICATES_P12 != ''
        env:
          CERTIFICATES_P12: ${{ secrets.CERTIFICATES_P12 }}
          CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          echo "$CERTIFICATES_P12" | base64 --decode > certificate.p12
          security import certificate.p12 \
            -k "$KEYCHAIN_PATH" \
            -P "$CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign

          security list-keychain -d user -s "$KEYCHAIN_PATH"

      - name: Archive app
        if: steps.check-project.outputs.exists == 'true'
        run: |
          xcodebuild archive \
            -scheme "${{ env.SCHEME }}" \
            -configuration "${{ env.CONFIGURATION }}" \
            -archivePath RealityAnnotation.xcarchive \
            | xcpretty

      - name: Export IPA
        if: steps.check-project.outputs.exists == 'true' && env.EXPORT_OPTIONS_PLIST != ''
        env:
          EXPORT_OPTIONS_PLIST: ${{ secrets.EXPORT_OPTIONS_PLIST }}
        run: |
          echo "$EXPORT_OPTIONS_PLIST" > ExportOptions.plist

          xcodebuild -exportArchive \
            -archivePath RealityAnnotation.xcarchive \
            -exportPath Export \
            -exportOptionsPlist ExportOptions.plist \
            | xcpretty

      - name: Upload archive
        if: steps.check-project.outputs.exists == 'true'
        uses: actions/upload-artifact@v3
        with:
          name: RealityAnnotation-Archive
          path: RealityAnnotation.xcarchive
          retention-days: 30

      - name: Upload IPA
        if: steps.check-project.outputs.exists == 'true' && hashFiles('Export/*.ipa') != ''
        uses: actions/upload-artifact@v3
        with:
          name: RealityAnnotation-IPA
          path: Export/*.ipa
          retention-days: 30

  validate:
    name: Validate Build
    runs-on: macos-14
    needs: [build-simulator, build-device]
    if: always()

    steps:
      - name: Check build status
        run: |
          echo "# Build Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Status" >> $GITHUB_STEP_SUMMARY
          echo "- Simulator Build: ${{ needs.build-simulator.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Device Build: ${{ needs.build-device.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.build-simulator.result }}" == "success" ]] && \
             [[ "${{ needs.build-device.result }}" == "success" ]]; then
            echo "âœ… All builds succeeded!" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "âŒ Some builds failed. Check individual job logs." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [build-simulator, build-device, archive]
    if: failure() && github.ref == 'refs/heads/main'

    steps:
      - name: Create issue on failure
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Build failed on ${context.ref}`,
              body: `Build workflow failed on ${context.ref}\n\nRun: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              labels: ['build-failure', 'automated']
            })

name: Deploy to App Store

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - testflight
          - appstore

jobs:
  build:
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.0'

      - name: Install dependencies
        run: |
          xcodebuild -resolvePackageDependencies

      - name: Run tests
        run: |
          xcodebuild test \
            -scheme AIAgentCoordinator \
            -destination 'platform=visionOS Simulator,name=Apple Vision Pro' \
            -enableCodeCoverage YES

      - name: Build archive
        run: |
          xcodebuild clean archive \
            -scheme AIAgentCoordinator \
            -destination 'generic/platform=visionOS' \
            -archivePath build/AIAgentCoordinator.xcarchive \
            -configuration Release

      - name: Export IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath build/AIAgentCoordinator.xcarchive \
            -exportPath build/ \
            -exportOptionsPlist ExportOptions.plist

      - name: Upload to TestFlight
        if: github.event.inputs.environment == 'testflight' || github.event_name == 'workflow_dispatch'
        env:
          APP_STORE_CONNECT_API_KEY: ${{ secrets.ASC_API_KEY }}
        run: |
          xcrun altool --upload-app \
            --type ios \
            --file build/AIAgentCoordinator.ipa \
            --apiKey ${{ secrets.ASC_KEY_ID }} \
            --apiIssuer ${{ secrets.ASC_ISSUER_ID }}

      - name: Create release notes
        run: |
          echo "## What's New in ${{ github.ref_name }}" > release_notes.md
          git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 @^)..@ >> release_notes.md

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: |
            build/*.ipa
            build/*.dSYM.zip
            release_notes.md

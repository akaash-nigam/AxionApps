name: Release

on:
  push:
    tags:
      - 'v*'
      - 'release-*'

jobs:
  validate-release:
    name: Validate Release Tag
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate version format
        run: |
          VERSION=$(echo ${{ github.ref }} | sed 's/refs\/tags\///')
          echo "Release version: $VERSION"
          if [[ ! $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
            echo "Invalid version format. Expected v1.0.0 or similar"
            exit 1
          fi

  build-release:
    name: Build Release
    runs-on: macos-14
    needs: validate-release

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Extract version
        id: version
        run: |
          VERSION=$(echo ${{ github.ref }} | sed 's/refs\/tags\///')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build Release Archive
        run: |
          mkdir -p Build/Release
          xcodebuild archive \
            -scheme RealityRealms \
            -configuration Release \
            -archivePath Build/Release/RealityRealms.xcarchive \
            -derivedDataPath Build/DerivedData \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO

      - name: Export IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath Build/Release/RealityRealms.xcarchive \
            -exportOptionsPlist ExportOptions.plist \
            -exportPath Build/Release/IPA
        continue-on-error: true

      - name: Create Release Notes
        run: |
          echo "# Release Notes - ${{ steps.version.outputs.version }}" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## Features" >> RELEASE_NOTES.md
          echo "- Immersive visionOS gaming experience" >> RELEASE_NOTES.md
          echo "- Real-time multiplayer support" >> RELEASE_NOTES.md
          echo "- Advanced AI-powered NPCs" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## Bug Fixes" >> RELEASE_NOTES.md
          echo "- Performance optimizations" >> RELEASE_NOTES.md
          echo "- Stability improvements" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## Requirements" >> RELEASE_NOTES.md
          echo "- visionOS 2.0 or later" >> RELEASE_NOTES.md
          echo "- Apple Vision Pro" >> RELEASE_NOTES.md

      - name: Compress Release Artifacts
        run: |
          cd Build/Release
          zip -r RealityRealms-${{ steps.version.outputs.version }}-xcarchive.zip RealityRealms.xcarchive/
          cd ../..

      - name: Upload Release Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: release-artifacts
          path: |
            Build/Release/RealityRealms-*.zip
            RELEASE_NOTES.md
          retention-days: 30

  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-release

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          name: release-artifacts

      - name: Extract version
        id: version
        run: |
          VERSION=$(echo ${{ github.ref }} | sed 's/refs\/tags\///')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body_path: RELEASE_NOTES.md
          files: |
            Build/Release/RealityRealms-*.zip
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  testflight-upload:
    name: Upload to TestFlight
    runs-on: macos-14
    needs: build-release
    # Uncomment when App Store credentials are configured
    # if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Download release artifacts
        uses: actions/download-artifact@v3
        with:
          name: release-artifacts

      - name: Decode App Store Connect API Key
        run: |
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY }}" | base64 -d > AuthKey.p8
        # Uncomment when credentials are available
        # if: secrets.APP_STORE_CONNECT_API_KEY != ''
        continue-on-error: true

      - name: Upload to TestFlight
        run: |
          # This requires valid App Store Connect credentials
          # xcrun altool --upload-app --file Build/Release/RealityRealms.ipa \
          #   --type ios \
          #   --apiKey AuthKey.p8 \
          #   --apiIssuer ${{ secrets.APP_STORE_ISSUER_ID }}
          echo "TestFlight upload would be executed with valid credentials"
        continue-on-error: true

      - name: Cleanup
        if: always()
        run: |
          rm -f AuthKey.p8

  release-summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [ build-release, create-github-release ]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## Release Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Version: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "Status: Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deliverables" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Release created" >> $GITHUB_STEP_SUMMARY
          echo "- Build artifacts archived" >> $GITHUB_STEP_SUMMARY
          echo "- Release notes generated" >> $GITHUB_STEP_SUMMARY

name: CI

on:
  push:
    branches: [ main, develop, claude/* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Run Tests
    runs-on: macos-14

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode_15.2.app

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Show available destinations
      run: xcodebuild -scheme HolographicBoardGames -showdestinations || true

    - name: Build and Test (visionOS Simulator)
      run: |
        xcodebuild clean test \
          -scheme HolographicBoardGames \
          -destination 'platform=visionOS Simulator,name=Apple Vision Pro' \
          -enableCodeCoverage YES \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          | xcpretty --color
      continue-on-error: true

    - name: Build and Test (iOS Simulator - Fallback)
      if: failure()
      run: |
        xcodebuild clean test \
          -scheme HolographicBoardGames \
          -destination 'platform=iOS Simulator,name=iPhone 15 Pro' \
          -enableCodeCoverage YES \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          | xcpretty --color

    - name: Generate Code Coverage Report
      if: success()
      run: |
        xcrun llvm-cov report \
          $(find ~/Library/Developer/Xcode/DerivedData -name "*.xctest") \
          -instr-profile=$(find ~/Library/Developer/Xcode/DerivedData -name "*.profdata") \
          > coverage-report.txt || true

    - name: Upload Coverage Report
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage-report.txt
        retention-days: 30

  lint:
    name: SwiftLint
    runs-on: macos-14

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install SwiftLint
      run: brew install swiftlint

    - name: Run SwiftLint
      run: |
        if [ -f .swiftlint.yml ]; then
          swiftlint --strict --reporter github-actions-logging
        else
          echo "No .swiftlint.yml found, skipping linting"
        fi
      continue-on-error: true

  build-package:
    name: Swift Package Build
    runs-on: macos-14

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build Swift Package
      run: swift build -v
      continue-on-error: true

    - name: Run Swift Package Tests
      run: swift test -v
      continue-on-error: true
